@using Zonit.Extensions.Cultures
@using Zonit.Extensions.Organizations
@using Zonit.Messaging.Tasks

@using Zonit.Services.Dashboard.Data
@using System.Timers

@namespace Zonit.Services.Dashboard.Areas.Dashboard.Components

@inject ICultureProvider Culture
@inject IWorkspaceProvider Workspace
@inject IExtensionManager ExtensionManager
@inject ITaskManager TaskManager
@implements IAsyncDisposable

<MudDrawer   
    Open="@ExtensionManager.Drawer(Extensions.Task).IsOpen"
    OpenChanged="@(value => ExtensionManager.Drawer(Extensions.Task).Set(value))" 
    Width="420px" Height="100%" Anchor="Anchor.End" Elevation="1" Variant="@DrawerVariant.Temporary">

    <MudDrawerHeader>
        <div class="d-flex align-center justify-space-between flex-grow-1 py-2">
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Task" Class="mr-3" Size="Size.Medium" Color="Color.Primary" />
                <MudText Typo="Typo.h5" Style="font-weight: 600;">@Culture.Translate("Task Manager")</MudText>
            </div>
            <MudIconButton OnClick="@(() => ExtensionManager.Drawer(Extensions.Task).Close())"
                       Icon=@Icons.Material.Filled.Close
                       Size="Size.Small"
                       Color="Color.Default"
                       aria-label="@Culture.Translate("Close panel")" />
        </div>
    </MudDrawerHeader>

    <hr class="mud-divider my-0" />


    <div Class="d-flex flex-column" style="height: calc(100vh - 140px); overflow-y: auto; background: #fafafa;">
        @if (!ActiveTasks.Any())
        {
            <div class="d-flex flex-column align-center justify-center" style="min-height: 300px; padding: 40px 20px;">
                <MudIcon Icon="@Icons.Material.Outlined.CheckCircleOutline" Size="Size.Large" 
                         Style="font-size: 64px; color: #90caf9; margin-bottom: 16px;" />
                <MudText Typo="Typo.h6" Align="Align.Center" Style="font-weight: 500; margin-bottom: 8px; color: #424242;">
                    @Culture.Translate("All Tasks Completed")
                </MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Style="color: #757575; max-width: 280px;">
                    @Culture.Translate("No active tasks are currently running")
                </MudText>
            </div>
        }
        else
        {
            <div class="pa-3">
                <MudText Typo="Typo.caption" Style="font-weight: 700; letter-spacing: 0.8px; color: #424242; padding: 8px 4px; font-size: 11px;">
                    @Culture.Translate("ACTIVE TASKS") · @ActiveTasks.Count()
                </MudText>

                <MudStack Spacing="2" Class="mt-2">
                    @foreach (var task in ActiveTasks.OrderBy(t => t.CreatedAt))
                    {
                        <MudPaper Elevation="0" Style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: white;">
                            <div style="padding: 14px;">
                                <!-- Header Row: Icon + Title + Status -->
                                <div class="d-flex align-center justify-space-between" style="margin-bottom: 10px;">
                                    <div class="d-flex align-center flex-grow-1" style="min-width: 0; gap: 10px;">
                                        <MudIcon Icon="@GetTaskIcon(task.Status)" 
                                                 Size="Size.Small" 
                                                 Style="@($"color: {GetTaskIconColor(task.Status)}; flex-shrink: 0; font-size: 20px;")" />
                                        <div style="flex-grow: 1; min-width: 0;">
                                            <MudText Typo="Typo.body1" Style="font-weight: 700; color: #1a1a1a; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; line-height: 1.4;">
                                                @GetTaskTitle(task)
                                            </MudText>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <MudText Typo="Typo.caption" Style="color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 3px; font-size: 12px;">
                                                    @task.Description
                                                </MudText>
                                            }
                                        </div>
                                    </div>
                                    <MudChip T="string" Size="Size.Small" 
                                             Color="@GetTaskStatusColor(task.Status)" 
                                             Variant="Variant.Filled"
                                             Style="font-weight: 700; font-size: 10px; height: 22px; margin-left: 10px; flex-shrink: 0; padding: 0 8px;">
                                        @GetTaskStatusText(task.Status)
                                    </MudChip>
                                </div>

                                <!-- Message (if available and different from title/description) -->
                                @if (!string.IsNullOrEmpty(task.Message) && 
                                     task.Message != GetTaskTitle(task) && 
                                     task.Message != task.Description)
                                {
                                    <div style="margin-bottom: 10px; padding: 6px 10px; background: #f5f5f5; border-radius: 4px;">
                                        <MudText Typo="Typo.caption" Style="color: #424242; font-size: 11px; font-style: italic;">
                                            @task.Message
                                        </MudText>
                                    </div>
                                }

                                <!-- Progress Section -->
                                @if (task.Progress.HasValue && task.Status == Zonit.Messaging.Tasks.TaskStatus.Processing)
                                {
                                    <div style="margin-bottom: 10px;">
                                        <!-- Time and percentage in one line -->
                                        <div class="d-flex align-center justify-space-between" style="margin-bottom: 6px;">
                                            @if (task.StartedAt.HasValue)
                                            {
                                                <div class="d-flex align-center">
                                                    <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Small" 
                                                             Style="font-size: 12px; color: #757575; margin-right: 4px;" />
                                                    <MudText Typo="Typo.caption" Style="color: #666; font-size: 10px; font-weight: 500;">
                                                        @GetTaskDuration(task)
                                                    </MudText>
                                                </div>
                                            }
                                            else
                                            {
                                                <span></span>
                                            }
                                            <MudText Typo="Typo.body2" Style="font-weight: 700; color: #1976d2; font-size: 13px;">
                                                @task.Progress.Value.ToString("0")%
                                            </MudText>
                                        </div>
                                        
                                        <!-- Progress bar -->
                                        <MudProgressLinear Color="Color.Primary" 
                                                           Value="@task.Progress.Value" 
                                                           Size="Size.Medium"
                                                           Style="height: 6px; border-radius: 3px;" />
                                    </div>
                                }
                                else if (task.Status == Zonit.Messaging.Tasks.TaskStatus.Pending)
                                {
                                    <!-- For pending tasks, show waiting message -->
                                    <div class="d-flex align-center" style="margin-bottom: 10px;">
                                        <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Small" 
                                                 Style="font-size: 14px; color: #757575; margin-right: 6px;" />
                                        <MudText Typo="Typo.caption" Style="color: #666; font-size: 11px; font-weight: 500;">
                                            @Culture.Translate("Waiting to start...")
                                        </MudText>
                                    </div>
                                }
                                else if (task.CompletedAt.HasValue && task.StartedAt.HasValue)
                                {
                                    <!-- For completed tasks, show completion time -->
                                    <div class="d-flex align-center" style="margin-bottom: 10px;">
                                        <MudIcon Icon="@Icons.Material.Outlined.Schedule" Size="Size.Small" 
                                                 Style="font-size: 14px; color: #757575; margin-right: 6px;" />
                                        <MudText Typo="Typo.caption" Style="color: #666; font-size: 11px; font-weight: 500;">
                                            <span>@Culture.Translate("Completed in") @GetElapsedTime(task.StartedAt.Value.DateTime, task.CompletedAt.Value.DateTime)</span>
                                        </MudText>
                                    </div>
                                }
                            </div>
                        </MudPaper>
                    }
                </MudStack>
            </div>
        }
    </div>
</MudDrawer>

@code{
private IEnumerable<TaskState> ActiveTasks { get; set; } = Enumerable.Empty<TaskState>();
private Timer? _timer;
private DateTime _currentTime = DateTime.UtcNow;
private bool _disposed = false;
private IDisposable? _taskSubscription;

    protected override void OnInitialized()
    {
        Culture.OnChange += StateHasChanged;
        Workspace.OnChange += StateHasChanged;
        ExtensionManager.Drawer(Extensions.Task)
            .OnChange += StateHasChanged;

        // Initialize timer for updating durations
        _timer = new Timer(1000);
        _timer.Elapsed += OnTimerElapsed;
        _timer.AutoReset = true;
        _timer.Start();

        ActiveTasks = TaskManager.GetActiveTasks(Workspace.Organization?.Id);
        
        // Subscribe to task changes
        if (Workspace.Organization?.Id != null)
        {
            _taskSubscription = TaskManager.OnChange(Workspace.Organization.Id, task =>
            {
                if (_disposed) return;
                
                ActiveTasks = TaskManager.GetActiveTasks(Workspace.Organization.Id);
                
                try
                {
                    InvokeAsync(StateHasChanged);
                }
                catch (ObjectDisposedException)
                {
                    // Component has been disposed, ignore
                }
                catch (InvalidOperationException)
                {
                    // Component is no longer in the render tree, ignore
                }
            });
        }
        else
        {
            _taskSubscription = TaskManager.OnChange(task =>
            {
                if (_disposed) return;
                
                ActiveTasks = TaskManager.GetActiveTasks();
                
                try
                {
                    InvokeAsync(StateHasChanged);
                }
                catch (ObjectDisposedException)
                {
                    // Component has been disposed, ignore
                }
                catch (InvalidOperationException)
                {
                    // Component is no longer in the render tree, ignore
                }
            });
        }
    }

    private async void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        if (_disposed) return;
        
        try
        {
            _currentTime = DateTime.UtcNow;
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException)
        {
            // Component has been disposed, stop the timer
            _timer?.Stop();
        }
        catch (InvalidOperationException)
        {
            // Component is no longer in the render tree, stop the timer
            _timer?.Stop();
        }
        catch (Exception)
        {
            // Any other exception during rendering, stop the timer to prevent crashes
            _timer?.Stop();
        }
    }

    private string GetTaskTitle(TaskState task)
    {
        // First check if there's a Title set
        if (!string.IsNullOrEmpty(task.Title))
        {
            return task.Title;
        }

        // Fall back to task type (simplified class name)
        if (!string.IsNullOrEmpty(task.TaskType))
        {
            var typeName = task.TaskType;
            var lastDot = typeName.LastIndexOf('.');
            if (lastDot >= 0 && lastDot < typeName.Length - 1)
            {
                typeName = typeName.Substring(lastDot + 1);
            }
            return typeName;
        }
        
        // Final fallback
        return Culture.Translate("Background Task");
    }

    private string GetTaskIcon(Zonit.Messaging.Tasks.TaskStatus status)
    {
        return status switch
        {
            Zonit.Messaging.Tasks.TaskStatus.Processing => Icons.Material.Filled.Autorenew,
            Zonit.Messaging.Tasks.TaskStatus.Completed => Icons.Material.Filled.CheckCircle,
            Zonit.Messaging.Tasks.TaskStatus.Failed => Icons.Material.Filled.Error,
            Zonit.Messaging.Tasks.TaskStatus.Cancelled => Icons.Material.Filled.Cancel,
            Zonit.Messaging.Tasks.TaskStatus.Pending => Icons.Material.Filled.Schedule,
            _ => Icons.Material.Filled.Circle,
        };
    }

    private string GetTaskIconColor(Zonit.Messaging.Tasks.TaskStatus status)
    {
        return status switch
        {
            Zonit.Messaging.Tasks.TaskStatus.Processing => "#1976d2",
            Zonit.Messaging.Tasks.TaskStatus.Completed => "#2e7d32",
            Zonit.Messaging.Tasks.TaskStatus.Failed => "#d32f2f",
            Zonit.Messaging.Tasks.TaskStatus.Cancelled => "#ed6c02",
            Zonit.Messaging.Tasks.TaskStatus.Pending => "#757575",
            _ => "#9e9e9e",
        };
    }

    private Color GetTaskStatusColor(Zonit.Messaging.Tasks.TaskStatus status)
    {
        return status switch
        {
            Zonit.Messaging.Tasks.TaskStatus.Processing => Color.Info,
            Zonit.Messaging.Tasks.TaskStatus.Completed => Color.Success,
            Zonit.Messaging.Tasks.TaskStatus.Failed => Color.Error,
            Zonit.Messaging.Tasks.TaskStatus.Cancelled => Color.Warning,
            _ => Color.Default,
        };
    }

    private string GetTaskStatusText(Zonit.Messaging.Tasks.TaskStatus status)
    {
        return status switch
        {
            Zonit.Messaging.Tasks.TaskStatus.Pending => Culture.Translate("Pending"),
            Zonit.Messaging.Tasks.TaskStatus.Processing => Culture.Translate("In Progress"),
            Zonit.Messaging.Tasks.TaskStatus.Completed => Culture.Translate("Completed"),
            Zonit.Messaging.Tasks.TaskStatus.Failed => Culture.Translate("Failed"),
            Zonit.Messaging.Tasks.TaskStatus.Cancelled => Culture.Translate("Cancelled"),
            _ => Culture.Translate("Unknown Status"),
        };
    }

    private string GetTaskTimeIcon(Zonit.Messaging.Tasks.TaskStatus status)
    {
        return status switch
        {
            Zonit.Messaging.Tasks.TaskStatus.Processing => Icons.Material.Filled.PlayArrow,
            Zonit.Messaging.Tasks.TaskStatus.Completed => Icons.Material.Filled.CheckCircle,
            Zonit.Messaging.Tasks.TaskStatus.Failed => Icons.Material.Filled.Error,
            Zonit.Messaging.Tasks.TaskStatus.Cancelled => Icons.Material.Filled.Cancel,
            _ => Icons.Material.Filled.Schedule,
        };
    }

    private string GetTaskDuration(TaskState task)
    {
        if (!task.StartedAt.HasValue)
            return Culture.Translate("Waiting to start");

        var duration = GetElapsedTime(task.StartedAt.Value.DateTime, _currentTime);
        return $"{Culture.Translate("Running for")} {duration}";
    }

    private string GetElapsedTime(DateTime start, DateTime end)
    {
        var duration = end - start;
        
        if (duration.TotalDays >= 1)
            return $"{Math.Floor(duration.TotalDays)}d {duration.Hours}h {duration.Minutes}m";
        else if (duration.TotalHours >= 1)
            return $"{duration.Hours}h {duration.Minutes}m {duration.Seconds}s";
        else if (duration.TotalMinutes >= 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        else
            return $"{duration.Seconds}s";
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        
        Culture.OnChange -= StateHasChanged;
        Workspace.OnChange -= StateHasChanged;
        ExtensionManager.Drawer(Extensions.Task)
            .OnChange -= StateHasChanged;
            
        _taskSubscription?.Dispose();
        _taskSubscription = null;
            
        if (_timer != null)
        {
            _timer.Stop();
            _timer.Elapsed -= OnTimerElapsed;
            _timer.Dispose();
            _timer = null;
        }

        await Task.CompletedTask;
    }
}